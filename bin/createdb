#!/usr/bin/env bash

set -e

export PGDATABASE="datumbazo"
export PGHOST="localhost"
export PGPASSWORD="scotch"
export PGPORT="5432"
export PGUSER="tiger"

# export PGDATABASE="datumbazo"
# export PGHOST="localhost"
# export PGPASSWORD="scotch"
# export PGPORT="32778"
# export PGUSER="postgres"

if [ ! -z "$1" ]; then PGDATABASE="$1"; fi

export PGURL="postgresql://$PGUSER:$PGPASSWORD@$PGHOST:$PGPORT/$PGDATABASE"
echo $PGURL

dropdb $PGDATABASE || true
createdb $PGDATABASE
psql < test-resources/db/test-db/migrations/deploy/create-postgis-extension.sql
psql < test-resources/db/test-db/migrations/deploy/create-citext-extension.sql
psql < test-resources/db/test-db/migrations/deploy/create-continents-table.sql
psql < test-resources/db/test-db/migrations/deploy/create-countries-table.sql
psql < test-resources/db/test-db/migrations/deploy/create-twitter-schema.sql
psql < test-resources/db/test-db/migrations/deploy/create-twitter-users-table.sql
psql < test-resources/db/test-db/migrations/deploy/create-twitter-tweets-table.sql
psql < test-resources/db/test-db/migrations/deploy/create-twitter-tweets-users.sql
lein run $PGURL test-resources/db/test-db/fixtures load

mysql -uroot -e "DROP DATABASE datumbazo;" || true
mysql -uroot -e "CREATE DATABASE datumbazo;"
mysql -uroot -e "GRANT ALL PRIVILEGES ON datumbazo.* TO tiger@localhost IDENTIFIED BY 'scotch';"
