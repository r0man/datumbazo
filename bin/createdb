#!/usr/bin/env bash

set -e

DATABASE_NAME="datumbazo"
USER=tiger

if [ ! -z "$1" ]; then DATABASE_NAME="$1"; fi

dropdb -U $USER $DATABASE_NAME || true
createdb -U $USER -O $USER --template template0 --encoding "UTF8" $DATABASE_NAME
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-postgis-extension.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-citext-extension.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-continents-table.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-countries-table.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-twitter-schema.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-twitter-users-table.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-twitter-tweets-table.sql
psql -U postgres datumbazo < test-resources/db/test-db/migrations/deploy/create-twitter-tweets-users.sql
lein run "postgresql://tiger:scotch@localhost/datumbazo" test-resources/db/test-db/fixtures load
